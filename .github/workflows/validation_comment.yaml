name: Comment on validation failure

on:
  workflow_run:
    workflows: ["Validate data"]
    types:
      - completed

permissions:
  pull-requests: write

jobs:
  comment:
    runs-on: ubuntu-24.04
    if: github.event.workflow_run.event == 'pull_request' && github.event.workflow_run.conclusion == 'failure'
    steps:
      - name: Download validation artifacts
        uses: actions/download-artifact@v4
        with:
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ github.token }}
          path: artifacts
          pattern: validation-output-*
          merge-multiple: false

      - name: Get PR number
        id: pr
        run: |
          PR_NUMBER=$(gh api repos/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }} --jq '.pull_requests[0].number')
          echo "number=$PR_NUMBER" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Post comment with validation errors
        if: steps.pr.outputs.number != ''
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          {
            echo "## :x: Validation Failed"
            echo ""
            for dir in artifacts/validation-output-*/; do
              if [ -d "$dir" ]; then
                name=$(basename "$dir" | sed 's/validation-output-//')
                echo "### $name"
                echo '```'
                cat "$dir/validation_output.txt"
                echo '```'
                echo ""
              fi
            done
          } > comment_body.txt

          gh pr comment ${{ steps.pr.outputs.number }} --repo ${{ github.repository }} --body-file comment_body.txt
